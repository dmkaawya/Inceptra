<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Based Voting</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background-color: #0f0f0f; color: #fff; text-align: center; padding: 20px; }
        .card { background: #1e1e1e; border: 1px solid #333; border-radius: 10px; padding: 15px; margin: 10px auto; max-width: 300px; }
        img { width: 100%; border-radius: 5px; }
        button { background: #00e676; color: #000; border: none; padding: 10px 20px; width: 100%; margin-top: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        #location-status { margin-bottom: 20px; color: #ff4081; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üèÜ ‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∂á‡∂≥‡∑î‡∂∏ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</h1>
    
    <div id="location-status">Location Check ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...</div>

    <div id="costume-list" style="display:none;"></div>

    <script>
        // ==========================================
        // 1. ‡∂¥‡∑Ñ‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (SETTINGS)
        // ==========================================
        
        // Supabase Keys
        const supabaseUrl = 'https://vegemuqhinyxeojfbdxd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ2VtdXFoaW55eGVvamZiZHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDkyNjIsImV4cCI6MjA4Njc4NTI2Mn0.xj1o2HaGqBBL-YpBLmHHBeUNOtNl20swXQBRp1RgdDk';
        
        // ==========================================
// 1. ‡∂¥‡∑Ñ‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (SETTINGS)
// ==========================================

// Event ‡∂ë‡∂ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂± ‡∂≠‡∑ê‡∂± (‡∂ö‡∑Ö‡∑î‡∂≠‡∂ª - J284+XXJ)
const TARGET_LAT = 6.5847; 
const TARGET_LNG = 79.9605;

// ‡∂∏‡∑ì‡∂ß‡∂ª‡∑ä 500‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠ ‡∂â‡∂±‡∑ä‡∂± ‡∂Ö‡∂∫‡∂ß ‡∑Ä‡∑í‡∂≠‡∂ª‡∂∫‡∑í Vote ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä
const MAX_DISTANCE_METERS = 500;

        // ==========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // ‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ Location ‡∂ë‡∂ö Check ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è
        function initLocationCheck() {
            if (!navigator.geolocation) {
                document.getElementById('location-status').innerText = "‡∂î‡∂∂‡∑ö Browser ‡∂ë‡∂ö‡∑ö Location ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠.";
                return;
            }

            document.getElementById('location-status').innerText = "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Location Access ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±...";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    // ‡∂Ø‡∑î‡∂ª ‡∂∏‡∂±‡∑í‡∂±‡∑Ä‡∑è
                    const distance = getDistanceFromLatLonInKm(userLat, userLng, TARGET_LAT, TARGET_LNG) * 1000; // Meters ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä
                    
                    console.log("‡∂î‡∂∂ ‡∑É‡∑í‡∂ß‡∑í‡∂± ‡∂Ø‡∑î‡∂ª (Meters): " + distance);

                    if (distance <= MAX_DISTANCE_METERS) {
                        document.getElementById('location-status').innerHTML = "‚úÖ Location ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∑Ä‡∑í‡∂∫! <br>‡∂î‡∂∂‡∂ß ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö.";
                        document.getElementById('location-status').style.color = "#00e676";
                        document.getElementById('costume-list').style.display = "block"; // List ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∂±‡∑Ä‡∑è
                        loadCostumes(); // Data load ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è
                    } else {
                        document.getElementById('location-status').innerHTML = `‚ùå ‡∂î‡∂∂ ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±‡∑ö Event ‡∂ë‡∂ö‡∂ß ‡∂¥‡∑í‡∂ß‡∂≠‡∑í‡∂±‡∑ä! <br> ‡∂∏‡∑ì‡∂ß‡∂ª‡∑ä ${Math.round(distance)} ‡∂ö‡∑ä ‡∂Ø‡∑î‡∂ª‡∑í‡∂±‡∑ä.`;
                    }
                },
                (error) => {
                    document.getElementById('location-status').innerText = "‚ö†Ô∏è Location Access ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑î‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠. ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö.";
                },
                { enableHighAccuracy: true } // GPS ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∂ú‡∂±‡∑ä‡∂± ‡∂ö‡∑í‡∂∫‡∂±‡∑Ä‡∑è
            );
        }

        async function loadCostumes() {
            const list = document.getElementById('costume-list');
            const { data, error } = await supabaseClient.from('costumes').select('*').order('id');
            
            if (error) {
                list.innerText = "Error loading data.";
                return;
            }

            const hasVoted = localStorage.getItem('has_voted_costume');

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <h3>${item.name}</h3>
                    <button onclick="vote(${item.id})" ${hasVoted ? 'disabled' : ''}>
                        ${hasVoted ? '‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠' : 'Vote Now'}
                    </button>
                `;
                list.appendChild(div);
            });
        }

        async function vote(id) {
            if(localStorage.getItem('has_voted_costume')) { alert("‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠!"); return; }
            
            document.querySelectorAll('button').forEach(b => { b.disabled = true; b.innerText = "Processing..."; });

            const { error } = await supabaseClient.rpc('vote_for_costume', { row_id: id });

            if (!error) {
                localStorage.setItem('has_voted_costume', 'true');
                alert("Vote Success!");
                document.querySelectorAll('button').forEach(b => b.innerText = "‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠");
            } else {
                alert("Error voting.");
                location.reload();
            }
        }

        // ‡∂Ø‡∑î‡∂ª ‡∂∏‡∂±‡∑í‡∂± ‡∂ú‡∂´‡∑í‡∂≠ ‡∑É‡∑ñ‡∂≠‡∑ä‚Äç‡∂ª‡∂∫ (Haversine Formula)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        // Start Process
        initLocationCheck();

    </script>
</body>
</html>
