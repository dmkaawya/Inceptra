<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote for Best Costume</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h1 { color: #00e676; margin-bottom: 5px; }
        p { color: #888; margin-bottom: 30px; }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
            transition: transform 0.2s;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            background: #333;
        }

        .card h3 { font-size: 18px; margin: 10px 0; }

        button {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            border: none;
            padding: 10px 20px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }

        button:active { transform: scale(0.95); }
        
        button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Spinner */
        .loader { border: 4px solid #333; border-top: 4px solid #00e676; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h1>üèÜ ‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∂á‡∂≥‡∑î‡∂∏ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</h1>
    <p>‡∂ë‡∂ö‡∑ä ‡∂Ö‡∂∫‡∑ô‡∂ö‡∑î‡∂ß ‡∂Ø‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑ä‡∂ö‡∑ö ‡∂ë‡∂ö‡∑ä ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫‡∂ö‡∑ä ‡∂¥‡∂∏‡∂´‡∑í.</p>

    <div id="loader" class="loader"></div>
    <div id="costume-list" class="card-container"></div>

    <script>
        // ‡∂î‡∂∂‡∑ö Supabase ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª (‡∂î‡∂∫‡∑è ‡∂ë‡∑Ä‡∂¥‡∑î ‡∂í‡∑Ä‡∑è)
        const supabaseUrl = 'https://vegemuqhinyxeojfbdxd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ2VtdXFoaW55eGVvamZiZHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDkyNjIsImV4cCI6MjA4Njc4NTI2Mn0.xj1o2HaGqBBL-YpBLmHHBeUNOtNl20swXQBRp1RgdDk';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function loadCostumes() {
            const list = document.getElementById('costume-list');
            const loader = document.getElementById('loader');

            // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
            const { data, error } = await supabase.from('costumes').select('*').order('id');
            
            loader.style.display = 'none';

            if (error) {
                list.innerHTML = `<p style="color:red">Error loading data. Please refresh.</p>`;
                return;
            }

            // ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä Vote ‡∂ö‡∂ª‡∂Ω‡∂Ø ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
            const hasVoted = localStorage.getItem('has_voted_costume');

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                // Image ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠‡∑í‡∂±‡∂∏‡∑ä Default ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í
                const imgDisplay = item.image_url ? `<img src="${item.image_url}">` : `<div style="height:150px; background:#333; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#555;">No Image</div>`;
                
                div.innerHTML = `
                    ${imgDisplay}
                    <h3>${item.name}</h3>
                    <button id="btn-${item.id}" onclick="vote(${item.id})" ${hasVoted ? 'disabled' : ''}>
                        ${hasVoted ? '‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠' : 'Vote Now'}
                    </button>
                `;
                list.appendChild(div);
            });
        }

        async function vote(id) {
            // 1. Double Check (Browser Level)
            if(localStorage.getItem('has_voted_costume')) {
                alert("‡∑É‡∂∏‡∑è‡∑Ä‡∂±‡∑ä‡∂±, ‡∂î‡∂∂ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª ‡∂á‡∂≠!");
                return;
            }

            // Button Disable ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (Visual Feedback)
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.innerText = "Processing...";
            });

            // 2. Supabase RPC Call ‡∂ë‡∂ö (Vote Count ‡∂ë‡∂ö ‡∑Ä‡∑ê‡∂©‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏)
            const { error } = await supabase.rpc('vote_for_costume', { row_id: id });

            if (!error) {
                // Success
                localStorage.setItem('has_voted_costume', 'true');
                alert("‡∂¢‡∂∫‡∑Ä‡∑ö‡∑Ä‡∑è! ‡∂î‡∂∂‡∑ö ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ä‡∑í‡∂∫.");
                allButtons.forEach(btn => btn.innerText = "‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠");
            } else {
                // Error
                alert("‡∂¥‡∑ú‡∂©‡∑í ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä‡∂ö‡∑ä. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
                console.error(error);
                // Buttons ‡∂Ü‡∂¥‡∑É‡∑î enable ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerText = "Vote Now";
                });
            }
        }

        loadCostumes();
    </script>
</body>
</html>
