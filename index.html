<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote for Best Costume</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background-color: #0f0f0f; color: #fff; text-align: center; padding: 20px; }
        .card { background: #1e1e1e; border: 1px solid #333; border-radius: 10px; padding: 15px; margin: 10px auto; max-width: 300px; }
        img { width: 100%; border-radius: 5px; }
        button { background: #00e676; color: #000; border: none; padding: 10px 20px; width: 100%; margin-top: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
    </style>
</head>
<body>

    <h1>üèÜ ‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∂á‡∂≥‡∑î‡∂∏ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</h1>
    <div id="status" style="color: yellow;">Loading...</div>
    <div id="costume-list"></div>

    <script>
        // 1. Supabase Client ‡∂ë‡∂ö ‡∑Ñ‡∂Ø‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ (‡∂±‡∂∏ ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∑Ö‡∑è: supabaseClient)
        const supabaseUrl = 'https://vegemuqhinyxeojfbdxd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ2VtdXFoaW55eGVvamZiZHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDkyNjIsImV4cCI6MjA4Njc4NTI2Mn0.xj1o2HaGqBBL-YpBLmHHBeUNOtNl20swXQBRp1RgdDk';
        
        // ‡∂∏‡∑ô‡∂≠‡∂± ‡∂≠‡∂∏‡∂∫‡∑í ‡∑Ä‡∑ô‡∂±‡∑É: 'supabase' ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∂ß 'supabaseClient' ‡∂Ø‡∑ê‡∂∏‡∑ä‡∂∏‡∑è
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        async function loadCostumes() {
            const list = document.getElementById('costume-list');
            const status = document.getElementById('status');

            // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ (supabaseClient ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä)
            const { data, error } = await supabaseClient.from('costumes').select('*').order('id');
            
            if (error) {
                console.error('Error:', error);
                status.innerHTML = "Error loading data! Please refresh.";
                return;
            }

            status.style.display = 'none'; // Loading ‡∂Ö‡∂∫‡∑í‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è

            // ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä Vote ‡∂ö‡∂ª‡∂Ω‡∂Ø ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
            const hasVoted = localStorage.getItem('has_voted_costume');

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <h3>${item.name}</h3>
                    <button id="btn-${item.id}" onclick="vote(${item.id})" ${hasVoted ? 'disabled' : ''}>
                        ${hasVoted ? '‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠' : 'Vote Now'}
                    </button>
                `;
                list.appendChild(div);
            });
        }

        async function vote(id) {
            if(localStorage.getItem('has_voted_costume')) {
                alert("‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠!");
                return;
            }

            // Buttons Disable
            document.querySelectorAll('button').forEach(b => { b.disabled = true; b.innerText = "Processing..."; });

            // Vote ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (RPC Call)
            const { error } = await supabaseClient.rpc('vote_for_costume', { row_id: id });

            if (!error) {
                localStorage.setItem('has_voted_costume', 'true');
                alert("Vote Success!");
                document.querySelectorAll('button').forEach(b => b.innerText = "‡∂°‡∂±‡∑ä‡∂Ø‡∂∫ ‡∂Ø‡∑ì ‡∂á‡∂≠");
            } else {
                alert("Error voting. Try again.");
                console.error(error);
                location.reload(); // Refresh page if error
            }
        }

        loadCostumes();
    </script>
</body>
</html>
