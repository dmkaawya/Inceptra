<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCEPTRA 25 | Live Voting</title>
    
    <!-- Supabase & Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            /* Neon Theme Colors based on Ticket Description */
            --bg-dark: #050505;
            --bg-panel: #0f0f16;
            --primary: #00f3ff;   /* Neon Cyan */
            --secondary: #bc13fe; /* Neon Purple */
            --accent: #f2ff00;    /* Electric Yellow */
            --danger: #ff0055;    /* Neon Red */
            --text-main: #ffffff;
            --text-dim: #8899a6;
            
            --glass: rgba(20, 20, 30, 0.7);
            --border-glow: 0 0 10px rgba(0, 243, 255, 0.3);
            --font-main: 'Rajdhani', sans-serif;
            --font-head: 'Orbitron', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Background Animation Canvas --- */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.6;
        }

        /* --- Layout --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        /* --- Typography & Header --- */
        .header-section { text-align: center; margin-bottom: 40px; padding-top: 20px; }
        .main-title {
            font-family: var(--font-head);
            font-size: 3.5rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            background: linear-gradient(90deg, #fff, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
            margin-bottom: 5px;
            animation: pulse 3s infinite ease-in-out;
        }
        .sub-title { font-size: 1.1rem; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
        
        /* --- Countdown Timer --- */
        .timer-wrapper {
            display: inline-flex;
            gap: 15px;
            margin-top: 25px;
            background: rgba(0,0,0,0.6);
            padding: 15px 30px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }
        .time-unit { text-align: center; }
        .time-val { font-family: var(--font-head); font-size: 2rem; font-weight: 700; color: var(--primary); display: block; line-height: 1; }
        .time-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; margin-top: 5px; }

        /* --- UI Components --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: transform 0.3s, border-color 0.3s;
        }
        .glass-panel:hover { border-color: rgba(0, 243, 255, 0.3); }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            padding: 12px 30px;
            color: white;
            font-family: var(--font-head);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(188, 19, 254, 0.5); }
        .btn:active { transform: translateY(1px); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); clip-path: none; border-radius: 4px; }
        .btn-outline:hover { background: var(--primary); color: #000; }
        .btn-danger { background: rgba(255, 0, 85, 0.1); border: 1px solid var(--danger); color: var(--danger); clip-path: none; }
        .btn-danger:hover { background: var(--danger); color: white; }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-field {
            width: 100%; padding: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            color: white;
            font-family: var(--font-main);
            font-size: 1rem;
            border-radius: 4px;
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        /* --- Voting Cards --- */
        .category-nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .cat-btn {
            padding: 10px 40px;
            background: transparent;
            border: 1px solid #333;
            color: #888;
            cursor: pointer;
            font-family: var(--font-head);
            text-transform: uppercase;
            transition: 0.3s;
            font-size: 1.1rem;
        }
        .cat-btn.active-boys { border-color: var(--primary); color: var(--primary); background: rgba(0, 243, 255, 0.05); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }
        .cat-btn.active-girls { border-color: var(--secondary); color: var(--secondary); background: rgba(188, 19, 254, 0.05); box-shadow: 0 0 15px rgba(188, 19, 254, 0.2); }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        
        .vote-card {
            background: rgba(10, 10, 15, 0.8);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #222;
            position: relative;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .vote-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.15);
            z-index: 2;
        }
        .card-img { width: 100%; height: 320px; object-fit: cover; border-bottom: 2px solid var(--primary); }
        .card-body { padding: 20px; text-align: center; }
        .card-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; }

        /* --- Admin & Stats --- */
        .stat-bar-bg { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .stat-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }
        .fill-boys { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .fill-girls { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }
        
        .leader-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 10px; border-left: 3px solid transparent; }
        .leader-row:hover { background: rgba(255,255,255,0.06); }
        .leader-row.boys { border-left-color: var(--primary); }
        .leader-row.girls { border-left-color: var(--secondary); }
        .rank-num { font-size: 1.5rem; font-weight: 800; color: rgba(255,255,255,0.2); width: 30px; }
        .avatar-sm { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }

        /* --- Status & Messages --- */
        .status-msg { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; text-align: center; }
        .status-ok { background: rgba(0, 243, 255, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .status-err { background: rgba(255, 0, 85, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        /* --- Utils --- */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-neon { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        
        /* Tabs */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-link { padding: 10px 20px; color: #888; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-weight: 600; }
        .tab-link:hover { color: white; }
        .tab-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        @keyframes pulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 20px rgba(0, 243, 255, 0.5); }
            50% { opacity: 0.8; text-shadow: 0 0 10px rgba(188, 19, 254, 0.5); }
        }
    </style>
</head>
<body>

    <!-- 2D Animated Background -->
    <canvas id="bg-canvas"></canvas>

    <div class="container">
        
        <!-- Header -->
        <header class="header-section">
            <h1 class="main-title">INCEPTRA 25</h1>
            <div class="sub-title">Where Beginnings Become Legacy</div>
            
            <div class="timer-wrapper" id="countdown-ui">
                <div class="time-unit"><span class="time-val" id="d-val">00</span><span class="time-label">Days</span></div>
                <div class="time-unit"><span class="time-val" id="h-val">00</span><span class="time-label">Hrs</span></div>
                <div class="time-unit"><span class="time-val" id="m-val">00</span><span class="time-label">Mins</span></div>
                <div class="time-unit"><span class="time-val" id="s-val">00</span><span class="time-label">Secs</span></div>
            </div>
        </header>

        <!-- AUTH VIEW -->
        <div id="auth-view" class="glass-panel" style="max-width: 400px; margin: 0 auto;">
            <h2 style="text-align: center; margin-bottom: 20px; font-family: var(--font-head);">System Access</h2>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email Address" class="input-field">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" class="input-field">
            </div>
            <div class="input-group hidden" id="name-group">
                <input type="text" id="fullname" placeholder="Full Name" class="input-field">
            </div>
            <button onclick="handleAuth()" class="btn" style="width: 100%;" id="auth-btn">LOGIN</button>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem; color: #888; cursor: pointer;" onclick="toggleAuthMode()">
                <span id="auth-toggle-text">New participant? Register here</span>
            </p>
        </div>

        <!-- MAIN APP VIEW -->
        <div id="app-view" class="hidden">
            <!-- Navbar -->
            <div class="glass-panel flex-between" style="margin-bottom: 30px; padding: 15px 25px;">
                <div>
                    <span style="color: #666; font-size: 0.8rem; text-transform: uppercase;">User:</span>
                    <span id="user-display" style="font-weight: 700; margin-left: 10px; color: var(--primary);">Guest</span>
                </div>
                <div>
                    <button onclick="logout()" class="btn-outline" style="padding: 8px 20px; font-size: 0.9rem;">LOGOUT</button>
                </div>
            </div>

            <!-- System Status (Location/Announcement) -->
            <div id="system-msg-area"></div>

            <!-- AUDIENCE SECTION -->
            <div id="audience-panel">
                <div class="category-nav">
                    <button class="cat-btn active-boys" id="btn-boys" onclick="switchCategory('boys')">Mr. Inceptra</button>
                    <button class="cat-btn" id="btn-girls" onclick="switchCategory('girls')">Ms. Inceptra</button>
                </div>

                <div id="grid-voting" class="grid-container">
                    <!-- Cards injected by JS -->
                </div>
            </div>

            <!-- ADMIN SECTION -->
            <div id="admin-panel" class="hidden">
                <div class="admin-tabs">
                    <div class="tab-link active" onclick="showAdminTab('live')">Live Results</div>
                    <div class="tab-link" onclick="showAdminTab('manage')">Manage</div>
                    <div class="tab-link" onclick="showAdminTab('config')">Settings</div>
                </div>

                <!-- Tab: Live Results -->
                <div id="tab-live">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="glass-panel">
                            <h3 class="text-neon" style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">MR. INCEPTRA</h3>
                            <div id="leaderboard-boys"></div>
                        </div>
                        <div class="glass-panel">
                            <h3 style="color: var(--secondary); text-shadow: 0 0 10px var(--secondary); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">MS. INCEPTRA</h3>
                            <div id="leaderboard-girls"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Manage -->
                <div id="tab-manage" class="hidden">
                    <div class="glass-panel" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--accent);">Add Contestant</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="new-c-name" placeholder="Name" class="input-field" style="flex: 1;">
                            <input type="text" id="new-c-img" placeholder="Image URL" class="input-field" style="flex: 2;">
                            <select id="new-c-gender" class="input-field" style="width: 120px;">
                                <option value="boys">Boy</option>
                                <option value="girls">Girl</option>
                            </select>
                            <button onclick="addContestant()" class="btn">ADD</button>
                        </div>
                    </div>
                    <div id="manage-list"></div>
                </div>

                <!-- Tab: Config -->
                <div id="tab-config" class="hidden">
                    <div class="glass-panel" style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Event Timer</h4>
                        <label style="color: #888; font-size: 0.9rem;">End Voting At:</label>
                        <input type="datetime-local" id="setting-time" class="input-field" style="margin-bottom: 10px;">
                        <button onclick="saveSettings()" class="btn">Save Time</button>
                    </div>
                    
                    <div class="glass-panel" style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Geofencing (Location Lock)</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="set-lat" placeholder="Lat (6.9271)" class="input-field">
                            <input type="number" id="set-lon" placeholder="Lon (79.8612)" class="input-field">
                            <input type="number" id="set-rad" placeholder="Radius (m)" class="input-field">
                        </div>
                        <button onclick="saveGeoSettings()" class="btn-outline">Update Location</button>
                    </div>

                    <div class="glass-panel">
                        <h4 style="color: var(--danger); margin-bottom: 15px;">Broadcast Announcement</h4>
                        <input type="text" id="set-anno" placeholder="Urgent message..." class="input-field" style="margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveAnnouncement()" class="btn" style="flex: 1;">Send</button>
                            <button onclick="clearAnnouncement()" class="btn-danger" style="flex: 1;">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- CONFIGURATION ---
    // NOTE: In a real production app, never expose the service_role key or anon key like this on the client side without RLS.
    // Using provided keys for functionality.
    const supabaseUrl = 'https://vegemuqhinyxeojfbdxd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ2VtdXFoaW55eGVvamZiZHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDkyNjIsImV4cCI6MjA4Njc4NTI2Mn0.xj1o2HaGqBBL-YpBLmHHBeUNOtNl20swXQBRp1RgdDk';
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    // --- STATE MANAGEMENT ---
    const state = {
        user: null,
        isAdmin: false,
        isRegistering: false,
        currentCategory: 'boys',
        costumes: [],
        userVotes: [],
        settings: {
            endTime: new Date('2025-12-31T23:59:59').getTime(),
            lat: 0,
            lon: 0,
            radius: 100,
            announcement: ''
        }
    };

    // --- BACKGROUND ANIMATION (2D CANVAS) ---
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 0.5;
            this.vy = (Math.random() - 0.5) * 0.5;
            this.size = Math.random() * 2;
            this.color = Math.random() > 0.5 ? '#00f3ff' : '#bc13fe';
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            if(this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if(this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        for(let i=0; i<80; i++) particles.push(new Particle());
    }

    function animateBg() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw connections
        ctx.lineWidth = 0.5;
        for(let i=0; i<particles.length; i++) {
            let p1 = particles[i];
            p1.update();
            p1.draw();
            for(let j=i; j<particles.length; j++) {
                let p2 = particles[j];
                let dx = p1.x - p2.x;
                let dy = p1.y - p2.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 150) {
                    ctx.strokeStyle = `rgba(100, 100, 255, ${1 - dist/150})`;
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
            }
        }
        requestAnimationFrame(animateBg);
    }
    initParticles();
    animateBg();


    // --- INITIALIZATION ---
    async function init() {
        await loadSystemSettings();
        startCountdown();
        
        const { data: { session } } = await sb.auth.getSession();
        if(session) {
            state.user = session.user;
            await checkRoleAndLoad();
        } else {
            document.getElementById('auth-view').classList.remove('hidden');
        }

        // Realtime subscriptions
        sb.channel('system_settings').on('postgres_changes', { event: 'UPDATE' }, payload => {
            state.settings = { ...state.settings, ...payload.new };
            updateSystemUI();
        }).subscribe();

        sb.channel('votes').on('postgres_changes', { event: 'INSERT' }, () => {
            if(state.isAdmin) loadAdminData();
            if(!state.isAdmin) loadUserVotes(); // Update buttons if needed
        }).subscribe();
        
        sb.channel('costumes').on('postgres_changes', { event: '*' }, () => {
            if(state.isAdmin) loadAdminData();
            if(!state.isAdmin) loadCostumes();
        }).subscribe();
    }

    // --- SETTINGS & UTILS ---
    async function loadSystemSettings() {
        const { data } = await sb.from('system_settings').select('*').eq('id', 1).single();
        if(data) {
            state.settings.endTime = new Date(data.voting_end_time).getTime();
            state.settings.lat = data.target_lat;
            state.settings.lon = data.target_long;
            state.settings.radius = data.radius_meters;
            state.settings.announcement = data.announcement;
            
            document.getElementById('setting-time').value = data.voting_end_time ? data.voting_end_time.slice(0,16) : '';
            document.getElementById('set-lat').value = state.settings.lat || '';
            document.getElementById('set-lon').value = state.settings.lon || '';
            document.getElementById('set-rad').value = state.settings.radius || '';
        }
        updateSystemUI();
    }

    function updateSystemUI() {
        // Update announcement
        const msgArea = document.getElementById('system-msg-area');
        if(state.settings.announcement) {
            msgArea.innerHTML = `<div class="status-msg" style="border-color: var(--accent); color: var(--accent);">üì¢ ${state.settings.announcement}</div>`;
        } else {
            msgArea.innerHTML = '';
        }
    }

    function startCountdown() {
        setInterval(() => {
            const now = new Date().getTime();
            const dist = state.settings.endTime - now;
            
            if(dist < 0) {
                document.getElementById('countdown-ui').innerHTML = "<h2 style='color:var(--danger)'>VOTING CLOSED</h2>";
                return;
            }

            const d = Math.floor(dist / (1000 * 60 * 60 * 24));
            const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((dist % (1000 * 60)) / 1000);

            document.getElementById('d-val').innerText = String(d).padStart(2, '0');
            document.getElementById('h-val').innerText = String(h).padStart(2, '0');
            document.getElementById('m-val').innerText = String(m).padStart(2, '0');
            document.getElementById('s-val').innerText = String(s).padStart(2, '0');
        }, 1000);
    }

    // --- AUTH ---
    function toggleAuthMode() {
        state.isRegistering = !state.isRegistering;
        document.getElementById('name-group').classList.toggle('hidden', !state.isRegistering);
        document.getElementById('auth-btn').innerText = state.isRegistering ? 'REGISTER' : 'LOGIN';
        document.getElementById('auth-toggle-text').innerText = state.isRegistering ? 'Have an account? Login' : 'New participant? Register here';
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const name = document.getElementById('fullname').value;
        
        if(!email || !pass) return alert("Please fill fields");

        if(state.isRegistering) {
            const { error } = await sb.auth.signUp({ 
                email, password: pass, 
                options: { data: { full_name: name } } 
            });
            if(error) alert(error.message);
            else alert("Registration successful! Please login.");
        } else {
            const { error } = await sb.auth.signInWithPassword({ email, password: pass });
            if(error) alert(error.message);
            else location.reload(); // Reload to init session
        }
    }

    async function logout() {
        await sb.auth.signOut();
        location.reload();
    }

    async function checkRoleAndLoad() {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', state.user.id).single();
        
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        document.getElementById('user-display').innerText = profile?.full_name || 'User';

        if(profile?.role === 'admin') {
            state.isAdmin = true;
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('audience-panel').classList.add('hidden');
            loadAdminData();
        } else {
            state.isAdmin = false;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('audience-panel').classList.remove('hidden');
            initVotingSystem();
        }
    }

    // --- VOTING SYSTEM (AUDIENCE) ---
    function initVotingSystem() {
        checkGeoLocation();
        loadCostumes();
        loadUserVotes();
    }

    function checkGeoLocation() {
        if(!navigator.geolocation) {
            showStatus("Geolocation not supported", "err");
            return;
        }
        
        if(state.settings.lat === 0) {
            showStatus("System not configured by Admin", "err");
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const dist = getDistance(pos.coords.latitude, pos.coords.longitude);
            if(dist <= state.settings.radius) {
                showStatus("‚úÖ Location Verified. You can vote.", "ok");
            } else {
                showStatus(`‚ùå Out of range. Distance: ${Math.round(dist)}m`, "err");
                document.getElementById('grid-voting').style.pointerEvents = 'none';
                document.getElementById('grid-voting').style.opacity = '0.5';
            }
        }, err => {
            showStatus("‚ùå Enable Location Permissions", "err");
        });
    }

    function showStatus(msg, type) {
        const el = document.getElementById('system-msg-area');
        const className = type === 'ok' ? 'status-ok' : 'status-err';
        el.innerHTML = `<div class="status-msg ${className}">${msg}</div>`;
    }

    async function loadCostumes() {
        const { data } = await sb.from('costumes').select('*');
        state.costumes = data || [];
        renderGrid();
    }

    async function loadUserVotes() {
        const { data } = await sb.from('votes').select('costume_id').eq('user_id', state.user.id);
        state.userVotes = data ? data.map(v => v.costume_id) : [];
        renderGrid();
    }

    function switchCategory(cat) {
        state.currentCategory = cat;
        document.getElementById('btn-boys').className = cat === 'boys' ? 'cat-btn active-boys' : 'cat-btn';
        document.getElementById('btn-girls').className = cat === 'girls' ? 'cat-btn active-girls' : 'cat-btn';
        renderGrid();
    }

    function renderGrid() {
        const container = document.getElementById('grid-voting');
        container.innerHTML = '';
        
        const filtered = state.costumes.filter(c => c.gender === state.currentCategory);
        const hasVotedInCat = filtered.some(c => state.userVotes.includes(c.id));

        filtered.forEach(c => {
            const isVoted = state.userVotes.includes(c.id);
            let btnState = '';
            
            if(hasVotedInCat) {
                if(isVoted) btnState = `<button class="btn" disabled style="background: #333; cursor: default;">VOTED</button>`;
                else btnState = `<button class="btn" disabled style="background: #222; color: #666; cursor: default;">LOCKED</button>`;
            } else {
                btnState = `<button onclick="vote(${c.id})" class="btn">VOTE NOW</button>`;
            }

            const card = document.createElement('div');
            card.className = 'vote-card';
            card.innerHTML = `
                <img src="${c.image_url}" class="card-img" onerror="this.src='https://picsum.photos/seed/${c.id}/300/400'">
                <div class="card-body">
                    <div class="card-name">${c.name}</div>
                    ${btnState}
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function vote(id) {
        const { error } = await sb.from('votes').insert([{ user_id: state.user.id, costume_id: id }]);
        if(error) alert("Error voting: " + error.message);
        else {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00f3ff', '#bc13fe', '#f2ff00'] });
            state.userVotes.push(id);
            renderGrid();
        }
    }

    // --- ADMIN FUNCTIONS ---
    function showAdminTab(tabName) {
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        ['live', 'manage', 'config'].forEach(t => {
            document.getElementById('tab-'+t).classList.add('hidden');
        });
        document.getElementById('tab-'+tabName).classList.remove('hidden');
    }

    async function loadAdminData() {
        // Get costumes with real vote counts (Simulated via query or column)
        // Since we have vote_count column in costumes table, we select that. 
        // Note: In a production app, you might want to count votes table directly to be sure.
        const { data } = await sb.from('costumes').select('*');
        state.costumes = data || [];

        const boys = state.costumes.filter(c => c.gender === 'boys').sort((a,b) => (b.vote_count||0) - (a.vote_count||0));
        const girls = state.costumes.filter(c => c.gender === 'girls').sort((a,b) => (b.vote_count||0) - (a.vote_count||0));
        
        renderLeaderboard(boys, 'leaderboard-boys', 'boys');
        renderLeaderboard(girls, 'leaderboard-girls', 'girls');
        renderManageList();
    }

    function renderLeaderboard(list, elemId, type) {
        const container = document.getElementById(elemId);
        const max = list.length > 0 ? (list[0].vote_count || 1) : 1;
        
        container.innerHTML = list.map((c, i) => `
            <div class="leader-row ${type}">
                <div class="rank-num">#${i+1}</div>
                <img src="${c.image_url}" class="avatar-sm">
                <div style="flex: 1;">
                    <div style="font-weight: 700;">${c.name}</div>
                    <div class="stat-bar-bg">
                        <div class="stat-bar-fill fill-${type}" style="width: ${(c.vote_count/max)*100}%"></div>
                    </div>
                </div>
                <div style="font-family: var(--font-head); font-size: 1.2rem;">${c.vote_count || 0}</div>
            </div>
        `).join('');
    }

    function renderManageList() {
        const container = document.getElementById('manage-list');
        container.innerHTML = state.costumes.map(c => `
            <div class="glass-panel flex-between" style="padding: 15px; margin-bottom: 10px;">
                <div style="display:flex; align-items:center; gap: 10px;">
                    <img src="${c.image_url}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;">
                    <div>
                        <div style="font-weight: bold;">${c.name}</div>
                        <small style="color:#666">${c.gender}</small>
                    </div>
                </div>
                <button onclick="deleteContestant(${c.id})" class="btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">DELETE</button>
            </div>
        `).join('');
    }

    async function addContestant() {
        const name = document.getElementById('new-c-name').value;
        const img = document.getElementById('new-c-img').value;
        const gender = document.getElementById('new-c-gender').value;
        
        if(!name || !img) return alert("Fill details");
        
        const { error } = await sb.from('costumes').insert([{ name, image_url: img, gender, vote_count: 0 }]);
        if(error) alert(error.message);
        else {
            document.getElementById('new-c-name').value = '';
            document.getElementById('new-c-img').value = '';
            loadAdminData();
        }
    }

    async function deleteContestant(id) {
        if(confirm("Delete this contestant?")) {
            await sb.from('costumes').delete().eq('id', id);
            loadAdminData();
        }
    }

    async function saveSettings() {
        const time = document.getElementById('setting-time').value;
        const { error } = await sb.from('system_settings').update({ voting_end_time: time }).eq('id', 1);
        if(error) alert("Error");
        else alert("Time Saved");
    }

    async function saveGeoSettings() {
        const lat = parseFloat(document.getElementById('set-lat').value);
        const lon = parseFloat(document.getElementById('set-lon').value);
        const rad = parseFloat(document.getElementById('set-rad').value);
        
        const { error } = await sb.from('system_settings').update({ target_lat: lat, target_long: lon, radius_meters: rad }).eq('id', 1);
        if(error) alert("Error");
        else alert("Location Settings Saved");
    }

    async function saveAnnouncement() {
        const msg = document.getElementById('set-anno').value;
        await sb.from('system_settings').update({ announcement: msg }).eq('id', 1);
    }

    async function clearAnnouncement() {
        document.getElementById('set-anno').value = '';
        await sb.from('system_settings').update({ announcement: '' }).eq('id', 1);
    }

    // --- HELPER: HAVERSINE FORMULA ---
    function getDistance(lat1, lon1) {
        const R = 6371e3; // meters
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = state.settings.lat * Math.PI/180;
        const ŒîœÜ = (state.settings.lat-lat1) * Math.PI/180;
        const ŒîŒª = (state.settings.lon-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // --- START ---
    init();
</script>
</body>
</html>
