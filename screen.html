<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inceptra25 | Where Beginnings Become Legacy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #030305;
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-pink: #ff0055;
            --glass-bg: rgba(10, 10, 15, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #8892b0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(188, 19, 254, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.15) 0%, transparent 40%);
        }

        /* --- Typography --- */
        h1, h2, h3, .brand-font { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        
        .container { width: 100%; max-width: 1300px; margin: 0 auto; padding: 20px; position: relative; z-index: 2; }

        /* --- Header & Hero --- */
        .hero-section { text-align: center; margin-bottom: 50px; position: relative; padding: 40px 0; }
        
        .main-title {
            font-size: 3.5rem; font-weight: 900; text-transform: uppercase;
            background: linear-gradient(90deg, #fff, var(--neon-cyan), var(--neon-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(0, 243, 255, 0.4));
            margin-bottom: 10px; line-height: 1.1;
        }

        .slogan {
            font-size: 1.2rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 4px;
            margin-bottom: 30px; border-bottom: 1px solid var(--neon-purple); display: inline-block; padding-bottom: 10px;
        }

        /* --- Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: 0.3s;
        }
        .glass-panel:hover { border-color: rgba(255, 255, 255, 0.2); }

        .neon-btn {
            background: transparent; color: var(--neon-cyan); border: 1px solid var(--neon-cyan);
            padding: 12px 30px; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; text-transform: uppercase;
            cursor: pointer; border-radius: 4px; transition: all 0.3s ease; position: relative; overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }
        .neon-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 25px rgba(0, 243, 255, 0.6); }
        
        .neon-btn.secondary { border-color: var(--neon-purple); color: var(--neon-purple); }
        .neon-btn.secondary:hover { background: var(--neon-purple); color: #fff; box-shadow: 0 0 25px rgba(188, 19, 254, 0.6); }

        .neon-btn.danger { border-color: var(--neon-pink); color: var(--neon-pink); font-size: 0.8rem; padding: 8px 16px; }
        .neon-btn.danger:hover { background: var(--neon-pink); color: #fff; }

        /* --- Inputs --- */
        .input-field {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border);
            color: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; font-family: 'Rajdhani', sans-serif; font-size: 1.1rem;
        }
        .input-field:focus { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        /* --- Countdown --- */
        .timer-display {
            font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--neon-cyan);
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.5); margin-top: 10px;
        }

        /* --- Voting Grid --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        
        .candidate-card {
            background: rgba(0,0,0,0.6); border-radius: 12px; overflow: hidden; position: relative;
            border: 1px solid transparent; transition: 0.4s ease;
        }
        .candidate-card:hover { transform: translateY(-8px); border-color: var(--neon-cyan); box-shadow: 0 10px 30px rgba(0, 243, 255, 0.2); }
        
        .card-img-wrapper { width: 100%; height: 320px; overflow: hidden; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .candidate-card:hover .card-img { transform: scale(1.1); }
        
        .card-overlay {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(to top, #000 0%, transparent 100%);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .c-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 15px; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }

        /* --- Tabs --- */
        .category-switch {
            display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;
        }
        .cat-btn {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-dim);
            padding: 10px 40px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 1.2rem;
            border-radius: 30px; transition: 0.3s;
        }
        .cat-btn.active-cyan { background: rgba(0, 243, 255, 0.1); border-color: var(--neon-cyan); color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }
        .cat-btn.active-pink { background: rgba(255, 0, 85, 0.1); border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 15px rgba(255, 0, 85, 0.2); }

        /* --- Admin Specifics --- */
        .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; overflow-x: auto; }
        .nav-item { padding: 8px 16px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .nav-item.active { color: var(--neon-cyan); border-color: var(--neon-cyan); }
        
        .leaderboard-row { display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 8px; border-left: 3px solid transparent; }
        .leaderboard-row.boys { border-left-color: var(--neon-cyan); }
        .leaderboard-row.girls { border-left-color: var(--neon-pink); }
        
        .rank { font-family: 'Orbitron'; font-size: 1.5rem; color: rgba(255,255,255,0.2); width: 40px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid var(--glass-border); }
        .info { flex: 1; }
        .info h4 { font-size: 1.1rem; margin-bottom: 5px; }
        .progress-bg { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; width: 100%; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .vote-count { font-family: 'Orbitron'; font-size: 1.2rem; font-weight: bold; color: #fff; }

        /* --- Toast --- */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg { background: rgba(10, 10, 20, 0.95); border: 1px solid var(--neon-cyan); color: #fff; padding: 15px 25px; border-radius: 8px; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(10px); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 20px; display: inline-block; }
        .status-ok { background: rgba(0, 230, 118, 0.1); color: #00e676; border: 1px solid #00e676; }
        .status-err { background: rgba(255, 0, 85, 0.1); color: #ff0055; border: 1px solid #ff0055; }
        .status-wait { background: rgba(255, 193, 7, 0.1); color: #ffc107; border: 1px solid #ffc107; }

        @media (max-width: 768px) {
            .main-title { font-size: 2rem; }
            .grid-container { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="toast-box"></div>
    <div class="container">
        
        <!-- HERO HEADER -->
        <header class="hero-section">
            <h1 class="main-title">Inceptrra 25</h1>
            <div class="slogan">Where Beginnings Become Legacy</div>
            
            <div id="countdown-area" class="glass-panel hidden" style="display: inline-block; padding: 15px 40px;">
                <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px;">VOTING CLOSES IN</div>
                <div id="timer" class="timer-display">00:00:00</div>
            </div>
        </header>

        <!-- AUTH VIEW -->
        <div id="view-auth" class="glass-panel" style="max-width: 400px; margin: 0 auto;">
            <h2 class="text-center" style="margin-bottom: 20px;">Access Portal</h2>
            <div class="input-group">
                <input type="email" id="email" placeholder="Email Address" class="input-field">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Password" class="input-field">
            </div>
            <div class="input-group hidden" id="name-group">
                <input type="text" id="fullname" placeholder="Full Name" class="input-field">
            </div>
            
            <button onclick="handleAuth()" id="auth-btn" class="neon-btn" style="width: 100%;">Login</button>
            
            <p onclick="toggleMode()" style="margin-top: 20px; text-align: center; cursor: pointer; color: var(--text-dim); font-size: 0.9rem;">
                <span id="auth-toggle-text">New participant? Register here</span>
            </p>
        </div>

        <!-- AUDIENCE VIEW -->
        <div id="view-audience" class="hidden">
            <div class="flex-between glass-panel" style="margin-bottom: 30px; padding: 15px 25px;">
                <div>
                    <span style="color: var(--text-dim); font-size: 0.8rem;">OFFICER</span><br>
                    <span id="user-display" style="font-weight: bold; color: var(--neon-cyan);">User</span>
                </div>
                <button onclick="logout()" class="neon-btn danger">Disconnect</button>
            </div>

            <!-- Status Message -->
            <div id="broadcast-area" class="hidden text-center" style="margin-bottom: 20px; color: var(--neon-pink); font-weight: bold; text-transform: uppercase;"></div>

            <!-- Location Check -->
            <div id="geo-status" class="text-center">
                <div class="status-badge status-wait">üõ∞Ô∏è Initializing Geo-Lock...</div>
            </div>

            <div class="category-switch">
                <button onclick="setCategory('boys')" id="btn-boys" class="cat-btn active-cyan">BOYS</button>
                <button onclick="setCategory('girls')" id="btn-girls" class="cat-btn">GIRLS</button>
            </div>

            <div id="candidates-grid" class="grid-container"></div>
        </div>

        <!-- ADMIN VIEW -->
        <div id="view-admin" class="hidden">
            <div class="flex-between" style="margin-bottom: 20px;">
                <h2 style="color: var(--neon-purple);">Command Center</h2>
                <button onclick="logout()" class="neon-btn danger">Logout</button>
            </div>

            <div class="admin-nav">
                <div onclick="switchAdminTab('live')" class="nav-item active" id="nav-live">Live Feed</div>
                <div onclick="switchAdminTab('manage')" class="nav-item" id="nav-manage">Contestants</div>
                <div onclick="switchAdminTab('settings')" class="nav-item" id="nav-settings">System</div>
            </div>

            <!-- Tab: Live Feed -->
            <div id="tab-live">
                <div class="flex-between" style="margin-bottom: 20px;">
                    <h3>Leaderboard</h3>
                    <div>
                        <button onclick="exportCSV()" class="neon-btn secondary">Export Data</button>
                        <button onclick="projectorMode()" class="neon-btn">Projector</button>
                    </div>
                </div>
                
                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div class="glass-panel">
                        <h3 class="text-center" style="color: var(--neon-cyan); margin-bottom: 20px; border-bottom: 1px solid var(--neon-cyan); display:inline-block;">BOYS</h3>
                        <div id="leaderboard-boys"></div>
                    </div>
                    <div class="glass-panel">
                        <h3 class="text-center" style="color: var(--neon-pink); margin-bottom: 20px; border-bottom: 1px solid var(--neon-pink); display:inline-block;">GIRLS</h3>
                        <div id="leaderboard-girls"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Manage -->
            <div id="tab-manage" class="hidden">
                <div class="glass-panel" style="margin-bottom: 20px;">
                    <h3 style="color: var(--neon-purple); margin-bottom: 15px;">Inject New Contestant</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="new-c-name" placeholder="Codename / Name" class="input-field">
                        <select id="new-c-gender" class="input-field">
                            <option value="boys">Boy</option>
                            <option value="girls">Girl</option>
                        </select>
                    </div>
                    <input type="text" id="new-c-img" placeholder="Image URL (Direct Link)" class="input-field">
                    <button onclick="addContestant()" class="neon-btn">Initialize</button>
                </div>
                <div id="manage-list"></div>
            </div>

            <!-- Tab: Settings -->
            <div id="tab-settings" class="hidden">
                <div class="glass-panel">
                    <h3>System Protocols</h3>
                    <label style="color:var(--text-dim); display:block; margin-top:15px;">Voting Deadline</label>
                    <input type="datetime-local" id="set-time" class="input-field">
                    <button onclick="saveTime()" class="neon-btn">Update Chronometer</button>

                    <hr style="border:0; border-top:1px solid var(--glass-border); margin: 30px 0;">

                    <h3>Geo-Fence Coordinates</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" step="any" id="set-lat" placeholder="Latitude" class="input-field">
                        <input type="number" step="any" id="set-long" placeholder="Longitude" class="input-field">
                    </div>
                    <input type="number" id="set-rad" placeholder="Radius (Meters)" class="input-field">
                    <button onclick="saveGeo()" class="neon-btn secondary">Update Perimeter</button>
                    
                    <hr style="border:0; border-top:1px solid var(--glass-border); margin: 30px 0;">
                    
                    <h3>Broadcast</h3>
                    <input type="text" id="set-msg" placeholder="Urgent message to all users..." class="input-field">
                    <div class="flex-between">
                        <button onclick="saveMsg()" class="neon-btn">Transmit</button>
                        <button onclick="clearMsg()" class="neon-btn danger">Clear</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://vegemuqhinyxeojfbdxd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ2VtdXFoaW55eGVvamZiZHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDkyNjIsImV4cCI6MjA4Njc4NTI2Mn0.xj1o2HaGqBBL-YpBLmHHBeUNOtNl20swXQBRp1RgdDk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE ---
    let user = null;
    let isRegister = false;
    let currentCat = 'boys';
    let costumes = [];
    let myVotes = [];
    let settings = {
        endTime: new Date().getTime() + 86400000,
        lat: 0, long: 0, radius: 0,
        msg: ''
    };

    // --- UTILS ---
    const $ = id => document.getElementById(id);
    const showToast = (msg, type='info') => {
        const box = $('toast-box');
        const t = document.createElement('div');
        t.className = 'toast-msg';
        t.style.borderColor = type === 'error' ? 'var(--neon-pink)' : 'var(--neon-cyan)';
        t.innerHTML = `<span>${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span> ${msg}`;
        box.appendChild(t);
        setTimeout(() => t.remove(), 3500);
    };

    // --- INIT ---
    async function init() {
        await loadSettings();
        setupRealtime();
        
        const { data: { session } } = await supabase.auth.getSession();
        if(session) {
            user = session.user;
            // Check profile for admin role
            const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
            
            if(profile?.role === 'admin') {
                showView('view-admin');
                loadAdminData();
            } else {
                showView('view-audience');
                loadAudienceData();
            }
            startTimer();
        } else {
            showView('view-auth');
        }
    }

    // --- AUTH ---
    function toggleMode() {
        isRegister = !isRegister;
        $('name-group').classList.toggle('hidden', !isRegister);
        $('auth-btn').innerText = isRegister ? 'Register ID' : 'Login';
        $('auth-toggle-text').innerText = isRegister ? 'Existing ID? Login' : 'New participant? Register here';
    }

    async function handleAuth() {
        const email = $('email').value;
        const pass = $('password').value;
        const name = $('fullname').value;
        
        if(!email || !pass) return showToast("Credentials required", "error");

        if(isRegister) {
            const { error } = await supabase.auth.signUp({
                email, password, 
                options: { data: { full_name: name } }
            });
            if(error) return showToast(error.message, "error");
            showToast("ID Registered. Please Login.", "success");
            toggleMode();
        } else {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if(error) return showToast(error.message, "error");
            window.location.reload(); // Reload to trigger init check
        }
    }

    async function logout() {
        await supabase.auth.signOut();
        window.location.reload();
    }

    // --- DATA LOADING ---
    async function loadSettings() {
        const { data } = await supabase.from('system_settings').select('*').eq('id', 1).single();
        if(data) {
            settings.endTime = new Date(data.voting_end_time).getTime();
            settings.lat = data.target_lat || 0;
            settings.long = data.target_long || 0;
            settings.radius = data.radius_meters || 0;
            settings.msg = data.announcement || '';
            
            // UI Updates
            $('set-time').value = new Date(data.voting_end_time).toISOString().slice(0, 16);
            $('set-lat').value = settings.lat;
            $('set-long').value = settings.long;
            $('set-rad').value = settings.radius;
            $('set-msg').value = settings.msg;
            
            if(settings.msg) {
                $('broadcast-area').innerText = "üì¢ " + settings.msg;
                $('broadcast-area').classList.remove('hidden');
            }
        }
    }

    function setupRealtime() {
        supabase.channel('public:system_settings')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public' }, payload => {
            settings.endTime = new Date(payload.new.voting_end_time).getTime();
            settings.msg = payload.new.announcement;
            if(settings.msg) {
                $('broadcast-area').innerText = "üì¢ " + settings.msg;
                $('broadcast-area').classList.remove('hidden');
            } else {
                $('broadcast-area').classList.add('hidden');
            }
            showToast("System Parameters Updated", "info");
        }).subscribe();

        supabase.channel('public:costumes')
        .on('postgres_changes', { event: '*', schema: 'public' }, () => {
            if(!$('view-admin').classList.contains('hidden')) loadAdminData();
        }).subscribe();
    }

    // --- AUDIENCE LOGIC ---
    async function loadAudienceData() {
        $('user-display').innerText = user.user_metadata.full_name || 'Agent';
        checkGeo();
        
        const { data: c } = await supabase.from('costumes').select('*');
        costumes = c || [];
        
        const { data: v } = await supabase.from('votes').select('costume_id').eq('user_id', user.id);
        myVotes = v ? v.map(x => x.costume_id) : [];
        
        renderGrid();
    }

    function checkGeo() {
        const status = $('geo-status');
        if(!settings.lat) {
            status.innerHTML = `<div class="status-badge status-wait">‚è≥ System Coordinates Awaiting Input</div>`;
            return;
        }

        if(!navigator.geolocation) {
            status.innerHTML = `<div class="status-badge status-err">‚ùå GPS Module Failure</div>`;
            return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const dist = getDistance(pos.coords.latitude, pos.coords.longitude, settings.lat, settings.long);
            if(dist <= settings.radius) {
                status.innerHTML = `<div class="status-badge status-ok">‚úÖ LOCATION VERIFIED (${Math.round(dist)}m)</div>`;
            } else {
                status.innerHTML = `<div class="status-badge status-err">‚ùå OUTSIDE PERIMETER (${Math.round(dist)}m)</div>`;
                // Optionally disable voting here
            }
        }, () => {
            status.innerHTML = `<div class="status-badge status-err">‚ùå PERMISSION DENIED</div>`;
        });
    }

    function setCategory(cat) {
        currentCat = cat;
        $('btn-boys').className = cat === 'boys' ? 'cat-btn active-cyan' : 'cat-btn';
        $('btn-girls').className = cat === 'girls' ? 'cat-btn active-pink' : 'cat-btn';
        renderGrid();
    }

    function renderGrid() {
        const grid = $('candidates-grid');
        grid.innerHTML = '';
        
        const filtered = costumes.filter(c => c.gender === currentCat);
        const hasVoted = filtered.some(c => myVotes.includes(c.id));

        filtered.forEach(c => {
            const voted = myVotes.includes(c.id);
            let btnState = '';
            
            if(hasVoted) {
                if(voted) btnState = `<button class="neon-btn" disabled style="border-color:#00e676; color:#00e676; cursor:default;">VOTED</button>`;
                else btnState = `<button class="neon-btn" disabled style="opacity:0.5; cursor:not-allowed;">LOCKED</button>`;
            } else {
                btnState = `<button onclick="vote(${c.id})" class="neon-btn">VOTE</button>`;
            }

            const html = `
                <div class="candidate-card">
                    <div class="card-img-wrapper">
                        <img src="${c.image_url}" class="card-img" onerror="this.src='https://placehold.co/400x500/111/00f3ff?text=NO+IMAGE'">
                    </div>
                    <div class="card-overlay">
                        <div class="c-name">${c.name}</div>
                        ${btnState}
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        });
    }

    async function vote(id) {
        if(!confirm("Confirm vote submission?")) return;
        const { error } = await supabase.from('votes').insert([{ user_id: user.id, costume_id: id }]);
        if(error) {
            showToast("Transmission Failed", "error");
        } else {
            myVotes.push(id);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00f3ff', '#bc13fe'] });
            showToast("Vote Received", "success");
            renderGrid();
        }
    }

    // --- ADMIN LOGIC ---
    async function loadAdminData() {
        const { data: c } = await supabase.from('costumes').select('*').order('vote_count', { ascending: false });
        costumes = c || [];

        // Render Leaderboards
        const boys = costumes.filter(x => x.gender === 'boys');
        const girls = costumes.filter(x => x.gender === 'girls');
        const maxB = boys[0]?.vote_count || 1;
        const maxG = girls[0]?.vote_count || 1;

        const renderLb = (list, max, color, elId) => {
            $(elId).innerHTML = list.map((c, i) => `
                <div class="leaderboard-row ${c.gender}">
                    <div class="rank">#${i+1}</div>
                    <img src="${c.image_url}" class="avatar">
                    <div class="info">
                        <h4>${c.name}</h4>
                        <div class="progress-bg"><div class="progress-fill" style="width:${(c.vote_count/max)*100}%; background:${color}"></div></div>
                    </div>
                    <div class="vote-count">${c.vote_count}</div>
                </div>
            `).join('');
        };

        renderLb(boys, maxB, 'var(--neon-cyan)', 'leaderboard-boys');
        renderLb(girls, maxG, 'var(--neon-pink)', 'leaderboard-girls');

        // Render Manage List
        $('manage-list').innerHTML = costumes.map(c => `
            <div class="glass-panel" style="padding: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${c.image_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                    <div>
                        <b>${c.name}</b> <small style="color: var(--text-dim)">${c.gender}</small>
                    </div>
                </div>
                <button onclick="deleteC(${c.id})" class="neon-btn danger" style="padding: 5px 10px;">X</button>
            </div>
        `).join('');
    }

    async function addContestant() {
        const name = $('new-c-name').value;
        const img = $('new-c-img').value;
        const gen = $('new-c-gender').value;
        if(!name || !img) return showToast("Data Incomplete", "error");
        
        await supabase.from('costumes').insert([{ name, image_url: img, gender: gen }]);
        showToast("Contestant Initialized", "success");
        $('new-c-name').value = '';
        $('new-c-img').value = '';
        loadAdminData();
    }

    async function deleteC(id) {
        if(confirm("Purge contestant data?")) {
            await supabase.from('costumes').delete().eq('id', id);
            loadAdminData();
        }
    }

    async function saveTime() {
        const val = $('set-time').value;
        await supabase.from('system_settings').update({ voting_end_time: val }).eq('id', 1);
        showToast("Time Synchronized", "success");
    }

    async function saveGeo() {
        const lat = parseFloat($('set-lat').value);
        const long = parseFloat($('set-long').value);
        const rad = parseInt($('set-rad').value);
        await supabase.from('system_settings').update({ target_lat: lat, target_long: long, radius_meters: rad }).eq('id', 1);
        showToast("Perimeter Set", "success");
    }

    async function saveMsg() {
        const m = $('set-msg').value;
        await supabase.from('system_settings').update({ announcement: m }).eq('id', 1);
        showToast("Broadcast Sent", "success");
    }
    
    async function clearMsg() {
        $('set-msg').value = '';
        await supabase.from('system_settings').update({ announcement: '' }).eq('id', 1);
    }

    function exportCSV() {
        let csv = "ID,Name,Gender,Votes\n";
        costumes.forEach(c => {
            csv += `${c.id},"${c.name}",${c.gender},${c.vote_count}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'Inceptra_Results.csv'; a.click();
    }

    function projectorMode() {
        const w = window.open('', '', 'width=1200,height=800');
        w.document.write(`
            <html>
            <head><title>Inceptra25 Live</title>
            <style>
                body { background: #000; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; height: 100vh; }
                .col { flex: 1; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
                .col:last-child { border: none; }
                h2 { text-align: center; text-transform: uppercase; margin-bottom: 30px; font-size: 2rem; }
                .boys { color: var(--neon-cyan, #00f3ff); border-bottom: 2px solid #00f3ff; }
                .girls { color: var(--neon-pink, #ff0055); border-bottom: 2px solid #ff0055; }
                .row { display: flex; align-items: center; margin-bottom: 20px; background: #111; padding: 10px; border-radius: 8px; }
                .rank { font-size: 2rem; font-weight: bold; width: 50px; color: #555; }
                .name { flex: 1; font-size: 1.5rem; margin-left: 20px; }
                .votes { font-size: 2rem; font-weight: bold; font-family: monospace; }
            </style>
            </head>
            <body>
                <div class="col">
                    <h2 class="boys">BOYS</h2>
                    <div id="b-list"></div>
                </div>
                <div class="col">
                    <h2 class="girls">GIRLS</h2>
                    <div id="g-list"></div>
                </div>
                <script>
                    setInterval(async () => {
                        const res = await fetch('${SUPABASE_URL}/rest/v1/costumes?select=*&order=vote_count.desc', { headers: { apikey: '${SUPABASE_KEY}' } });
                        const d = await res.json();
                        const b = d.filter(x => x.gender === 'boys');
                        const g = d.filter(x => x.gender === 'girls');
                        document.getElementById('b-list').innerHTML = b.map((c,i) => \`<div class="row"><div class="rank">\${i+1}</div><div class="name">\${c.name}</div><div class="votes" style="color:#00f3ff">\${c.vote_count}</div></div>\`).join('');
                        document.getElementById('g-list').innerHTML = g.map((c,i) => \`<div class="row"><div class="rank">\${i+1}</div><div class="name">\${c.name}</div><div class="votes" style="color:#ff0055">\${c.vote_count}</div></div>\`).join('');
                    }, 2000);
                </script>
            </body>
            </html>
        `);
    }

    // --- HELPERS ---
    function showView(id) {
        ['view-auth', 'view-audience', 'view-admin'].forEach(v => $(v).classList.add('hidden'));
        $(id).classList.remove('hidden');
    }

    function switchAdminTab(t) {
        ['live', 'manage', 'settings'].forEach(x => {
            $(`tab-${x}`).classList.add('hidden');
            $(`nav-${x}`).classList.remove('active');
        });
        $(`tab-${t}`).classList.remove('hidden');
        $(`nav-${t}`).classList.add('active');
    }

    function startTimer() {
        setInterval(() => {
            const now = new Date().getTime();
            const diff = settings.endTime - now;
            if(diff < 0) {
                $('timer').innerText = "VOTING CLOSED";
                $('timer').style.color = "red";
                return;
            }
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            $('timer').innerText = `${h}h ${m}m ${s}s`;
        }, 1000);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    init();
</script>
</body>
</html>
